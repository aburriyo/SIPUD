{% extends "base.html" %}

{% block title %}Cuadratura Bancaria{% endblock %}

{% block content %}
<div class="flex flex-col gap-6" x-data="reconciliationApp()">
    <!-- Header & Actions -->
    <div class="flex flex-col gap-3">
        <div>
            <h1 class="text-xl sm:text-2xl font-bold text-slate-800">Cuadratura Bancaria</h1>
            <p class="text-xs sm:text-sm text-slate-500">Conciliación de transacciones con ventas</p>
        </div>
        <div class="flex flex-wrap gap-3 justify-end">
            <button @click="showUploadModal = true"
                class="inline-flex items-center px-4 py-2.5 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 shadow-sm">
                <svg class="w-5 h-5 mr-2 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                Importar Cartola
            </button>
            <button @click="autoMatch()"
                :disabled="autoMatching"
                class="inline-flex items-center px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium shadow-sm disabled:opacity-50">
                <svg x-show="!autoMatching" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <svg x-show="autoMatching" class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                Auto-Conciliar
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
            <p class="text-xs text-slate-500">Total Transacciones</p>
            <p class="text-2xl font-bold text-slate-800" x-text="stats.total"></p>
        </div>
        <div class="bg-amber-50 rounded-xl shadow-sm border border-amber-200 p-4">
            <p class="text-xs text-amber-600">Pendientes</p>
            <p class="text-2xl font-bold text-amber-700" x-text="stats.pending"></p>
            <p class="text-xs text-amber-600" x-text="'$' + (stats.pending_amount || 0).toLocaleString('es-CL')"></p>
        </div>
        <div class="bg-green-50 rounded-xl shadow-sm border border-green-200 p-4">
            <p class="text-xs text-green-600">Conciliadas</p>
            <p class="text-2xl font-bold text-green-700" x-text="stats.matched"></p>
            <p class="text-xs text-green-600" x-text="'$' + (stats.matched_amount || 0).toLocaleString('es-CL')"></p>
        </div>
        <div class="bg-slate-50 rounded-xl shadow-sm border border-slate-200 p-4">
            <p class="text-xs text-slate-500">Tasa Conciliación</p>
            <p class="text-2xl font-bold text-slate-800" x-text="stats.match_rate + '%'"></p>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        <div class="flex flex-wrap gap-4 items-end">
            <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Estado</label>
                <select x-model="filters.status" @change="loadTransactions()" class="rounded-lg border-slate-300 text-sm">
                    <option value="">Todos</option>
                    <option value="pending">Pendientes</option>
                    <option value="matched">Conciliadas</option>
                    <option value="ignored">Ignoradas</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Desde</label>
                <input type="date" x-model="filters.date_from" @change="loadTransactions()" class="rounded-lg border-slate-300 text-sm">
            </div>
            <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Hasta</label>
                <input type="date" x-model="filters.date_to" @change="loadTransactions()" class="rounded-lg border-slate-300 text-sm">
            </div>
            <button @click="clearFilters()" class="text-sm text-slate-500 hover:text-slate-700">
                Limpiar filtros
            </button>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Fecha</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Descripción</th>
                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600">Monto</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600">Estado</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Venta Asociada</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600">Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    <template x-for="tx in transactions" :key="tx.id">
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 text-sm text-slate-700" x-text="tx.date"></td>
                            <td class="px-4 py-3">
                                <p class="text-sm text-slate-800 truncate max-w-xs" x-text="tx.description || '-'"></p>
                                <p class="text-xs text-slate-400" x-text="tx.reference" x-show="tx.reference"></p>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="text-sm font-medium" 
                                      :class="tx.transaction_type === 'credit' ? 'text-green-600' : 'text-red-600'"
                                      x-text="(tx.transaction_type === 'credit' ? '+' : '-') + '$' + tx.amount.toLocaleString('es-CL')"></span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                      :class="{
                                          'bg-amber-100 text-amber-800': tx.status === 'pending',
                                          'bg-green-100 text-green-800': tx.status === 'matched',
                                          'bg-slate-100 text-slate-600': tx.status === 'ignored'
                                      }"
                                      x-text="tx.status === 'pending' ? 'Pendiente' : tx.status === 'matched' ? 'Conciliada' : 'Ignorada'"></span>
                                <span class="text-xs text-slate-400 ml-1" x-show="tx.match_type" x-text="'(' + tx.match_type + ')'"></span>
                            </td>
                            <td class="px-4 py-3 text-sm text-slate-700">
                                <span x-show="tx.matched_sale_customer" x-text="tx.matched_sale_customer"></span>
                                <span x-show="!tx.matched_sale_customer" class="text-slate-400">-</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex justify-center gap-2">
                                    <button x-show="tx.status === 'pending'"
                                        @click="openMatchModal(tx)"
                                        class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                        Conciliar
                                    </button>
                                    <button x-show="tx.status === 'pending'"
                                        @click="ignoreTransaction(tx.id)"
                                        class="text-slate-400 hover:text-slate-600 text-sm">
                                        Ignorar
                                    </button>
                                    <button x-show="tx.status === 'matched'"
                                        @click="unmatchTransaction(tx.id)"
                                        class="text-red-500 hover:text-red-700 text-sm">
                                        Deshacer
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        
        <!-- Empty State -->
        <div x-show="transactions.length === 0" class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <p class="mt-2 text-sm text-slate-500">No hay transacciones. Importa una cartola para comenzar.</p>
        </div>
        
        <!-- Pagination -->
        <div class="px-4 py-3 border-t border-slate-200 flex justify-between items-center" x-show="pagination.pages > 1">
            <p class="text-sm text-slate-500">
                Página <span x-text="pagination.page"></span> de <span x-text="pagination.pages"></span>
            </p>
            <div class="flex gap-2">
                <button @click="prevPage()" :disabled="pagination.page === 1"
                    class="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50">
                    Anterior
                </button>
                <button @click="nextPage()" :disabled="pagination.page === pagination.pages"
                    class="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50">
                    Siguiente
                </button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div x-show="showUploadModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="fixed inset-0 bg-slate-900/50" @click="showUploadModal = false"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Importar Cartola Bancaria</h3>
                
                <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center"
                     @dragover.prevent="dragover = true"
                     @dragleave="dragover = false"
                     @drop.prevent="handleDrop($event)"
                     :class="{ 'border-indigo-500 bg-indigo-50': dragover }">
                    <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p class="mt-2 text-sm text-slate-600">Arrastra un archivo Excel aquí o</p>
                    <label class="mt-2 inline-block">
                        <span class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium cursor-pointer hover:bg-indigo-700">
                            Seleccionar archivo
                        </span>
                        <input type="file" accept=".xlsx,.xls" class="hidden" @change="handleFileSelect($event)">
                    </label>
                    <p class="mt-2 text-xs text-slate-400">Formatos: .xlsx, .xls</p>
                </div>
                
                <div x-show="uploadFile" class="mt-4 p-3 bg-slate-50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-700" x-text="uploadFile?.name"></span>
                        <button @click="uploadFile = null" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end gap-3">
                    <button @click="showUploadModal = false; uploadFile = null"
                        class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-700">
                        Cancelar
                    </button>
                    <button @click="uploadCartola()" :disabled="!uploadFile || uploading"
                        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium disabled:opacity-50">
                        <span x-show="!uploading">Importar</span>
                        <span x-show="uploading">Procesando...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Match Modal -->
    <div x-show="showMatchModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="fixed inset-0 bg-slate-900/50" @click="showMatchModal = false"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
                <div class="px-6 py-4 border-b border-slate-200">
                    <h3 class="text-lg font-bold text-slate-900">Conciliar Transacción</h3>
                    <div class="mt-2 p-3 bg-indigo-50 rounded-lg">
                        <p class="text-sm text-slate-600">
                            <span class="font-medium">Monto:</span> 
                            <span class="text-indigo-600 font-bold" x-text="'$' + (selectedTx?.amount || 0).toLocaleString('es-CL')"></span>
                        </p>
                        <p class="text-sm text-slate-600">
                            <span class="font-medium">Fecha:</span> 
                            <span x-text="selectedTx?.date"></span>
                        </p>
                        <p class="text-sm text-slate-600" x-show="selectedTx?.description">
                            <span class="font-medium">Descripción:</span> 
                            <span x-text="selectedTx?.description"></span>
                        </p>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- Suggestions -->
                    <div x-show="suggestions.length > 0" class="mb-6">
                        <h4 class="text-sm font-bold text-slate-800 mb-3">Sugerencias (por monto y fecha similar)</h4>
                        <div class="space-y-2">
                            <template x-for="s in suggestions" :key="s.sale_id">
                                <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg hover:border-indigo-300 cursor-pointer"
                                     @click="matchWithSale(s.sale_id)">
                                    <div>
                                        <p class="font-medium text-slate-800" x-text="s.customer"></p>
                                        <p class="text-sm text-slate-500">
                                            <span x-text="s.date"></span> · 
                                            <span class="font-medium" x-text="'$' + s.total.toLocaleString('es-CL')"></span>
                                        </p>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                              :class="s.confidence >= 80 ? 'bg-green-100 text-green-800' : s.confidence >= 50 ? 'bg-amber-100 text-amber-800' : 'bg-slate-100 text-slate-600'"
                                              x-text="s.confidence + '% match'"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Manual Search -->
                    <div>
                        <h4 class="text-sm font-bold text-slate-800 mb-3">Buscar venta manualmente</h4>
                        <div class="space-y-3">
                            <input type="text" x-model="saleSearch" @input.debounce.300ms="searchSales()"
                                placeholder="Buscar por cliente o monto..."
                                class="w-full rounded-lg border-slate-300 text-sm">
                            
                            <div class="max-h-48 overflow-y-auto space-y-2">
                                <template x-for="sale in unmatchedSales" :key="sale.id">
                                    <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg hover:border-indigo-300 cursor-pointer"
                                         @click="matchWithSale(sale.id)">
                                        <div>
                                            <p class="font-medium text-slate-800" x-text="sale.customer"></p>
                                            <p class="text-sm text-slate-500" x-text="sale.date"></p>
                                        </div>
                                        <span class="font-medium text-slate-700" x-text="'$' + sale.total.toLocaleString('es-CL')"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="px-6 py-4 border-t border-slate-200 flex justify-end">
                    <button @click="showMatchModal = false"
                        class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-700">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function reconciliationApp() {
    return {
        transactions: [],
        stats: { total: 0, pending: 0, matched: 0, ignored: 0, pending_amount: 0, matched_amount: 0, match_rate: 0 },
        filters: { status: '', date_from: '', date_to: '' },
        pagination: { page: 1, pages: 1, total: 0 },
        
        showUploadModal: false,
        showMatchModal: false,
        uploadFile: null,
        uploading: false,
        dragover: false,
        autoMatching: false,
        
        selectedTx: null,
        suggestions: [],
        unmatchedSales: [],
        saleSearch: '',
        
        init() {
            this.loadStats();
            this.loadTransactions();
        },
        
        async loadStats() {
            try {
                const resp = await fetch('/reconciliation/api/stats');
                this.stats = await resp.json();
            } catch (e) {
                console.error('Error loading stats:', e);
            }
        },
        
        async loadTransactions() {
            try {
                const params = new URLSearchParams({
                    page: this.pagination.page,
                    per_page: 50,
                    status: this.filters.status,
                    date_from: this.filters.date_from,
                    date_to: this.filters.date_to
                });
                const resp = await fetch('/reconciliation/api/transactions?' + params);
                const data = await resp.json();
                this.transactions = data.transactions;
                this.pagination = { page: data.page, pages: data.pages, total: data.total };
            } catch (e) {
                console.error('Error loading transactions:', e);
            }
        },
        
        clearFilters() {
            this.filters = { status: '', date_from: '', date_to: '' };
            this.pagination.page = 1;
            this.loadTransactions();
        },
        
        prevPage() {
            if (this.pagination.page > 1) {
                this.pagination.page--;
                this.loadTransactions();
            }
        },
        
        nextPage() {
            if (this.pagination.page < this.pagination.pages) {
                this.pagination.page++;
                this.loadTransactions();
            }
        },
        
        handleDrop(e) {
            this.dragover = false;
            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                this.uploadFile = file;
            }
        },
        
        handleFileSelect(e) {
            this.uploadFile = e.target.files[0];
        },
        
        async uploadCartola() {
            if (!this.uploadFile) return;
            
            this.uploading = true;
            const formData = new FormData();
            formData.append('file', this.uploadFile);
            
            try {
                const resp = await fetch('/reconciliation/api/transactions/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                
                if (data.success) {
                    alert(`Importadas ${data.created} transacciones.${data.total_errors > 0 ? ' Errores: ' + data.total_errors : ''}`);
                    this.showUploadModal = false;
                    this.uploadFile = null;
                    this.loadStats();
                    this.loadTransactions();
                } else {
                    alert('Error: ' + (data.error || 'Error desconocido'));
                }
            } catch (e) {
                alert('Error al subir archivo');
            }
            this.uploading = false;
        },
        
        async openMatchModal(tx) {
            this.selectedTx = tx;
            this.suggestions = [];
            this.unmatchedSales = [];
            this.showMatchModal = true;
            
            // Load suggestions
            try {
                const resp = await fetch(`/reconciliation/api/transactions/${tx.id}/suggestions`);
                const data = await resp.json();
                this.suggestions = data.suggestions;
            } catch (e) {
                console.error('Error loading suggestions:', e);
            }
            
            // Load unmatched sales
            await this.loadUnmatchedSales();
        },
        
        async loadUnmatchedSales() {
            try {
                const resp = await fetch('/reconciliation/api/sales/unmatched');
                const data = await resp.json();
                this.unmatchedSales = data.sales;
            } catch (e) {
                console.error('Error loading unmatched sales:', e);
            }
        },
        
        searchSales() {
            // Filter locally for now
            // Could implement server-side search if needed
        },
        
        async matchWithSale(saleId) {
            try {
                const resp = await fetch(`/reconciliation/api/transactions/${this.selectedTx.id}/match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sale_id: saleId })
                });
                const data = await resp.json();
                
                if (data.success) {
                    this.showMatchModal = false;
                    this.loadStats();
                    this.loadTransactions();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Error al conciliar');
            }
        },
        
        async unmatchTransaction(txId) {
            if (!confirm('¿Deseas deshacer esta conciliación?')) return;
            
            try {
                await fetch(`/reconciliation/api/transactions/${txId}/unmatch`, { method: 'POST' });
                this.loadStats();
                this.loadTransactions();
            } catch (e) {
                alert('Error al deshacer conciliación');
            }
        },
        
        async ignoreTransaction(txId) {
            if (!confirm('¿Marcar esta transacción como ignorada?')) return;
            
            try {
                await fetch(`/reconciliation/api/transactions/${txId}/ignore`, { method: 'POST' });
                this.loadStats();
                this.loadTransactions();
            } catch (e) {
                alert('Error al ignorar transacción');
            }
        },
        
        async autoMatch() {
            if (!confirm('¿Ejecutar auto-conciliación? Solo se conciliarán transacciones con ≥80% de confianza.')) return;
            
            this.autoMatching = true;
            try {
                const resp = await fetch('/reconciliation/api/transactions/auto-match', { method: 'POST' });
                const data = await resp.json();
                
                alert(`Auto-conciliación completada: ${data.matched} transacciones conciliadas.`);
                this.loadStats();
                this.loadTransactions();
            } catch (e) {
                alert('Error en auto-conciliación');
            }
            this.autoMatching = false;
        }
    }
}
</script>
{% endblock %}
