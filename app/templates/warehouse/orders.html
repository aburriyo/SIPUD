{% extends "base.html" %}

{% block title %}Pedidos a Proveedores{% endblock %}

{% block content %}
<div class="flex flex-col gap-6" x-data="ordersPage()">
    <!-- Header Section -->
    <div class="flex flex-col gap-4">
        <div>
            <h1 class="text-xl sm:text-2xl font-bold text-slate-800">Pedidos a Proveedores</h1>
            <p class="text-xs sm:text-sm text-slate-500">Registra y gestiona órdenes de compra</p>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 sm:justify-end flex-wrap">
            <!-- Proveedores: Plantilla + Subir -->
            <div class="flex gap-2">
                <a href="{{ url_for('warehouse.download_supplier_template') }}"
                    class="inline-flex items-center justify-center px-3 py-2.5 bg-white border border-emerald-300 rounded-lg text-sm font-medium text-emerald-700 hover:bg-emerald-50 shadow-sm transition-colors"
                    title="Descargar plantilla Excel para proveedores">
                    <svg class="w-4 h-4 mr-1.5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span class="hidden sm:inline">Plantilla Proveedores</span>
                    <span class="sm:hidden">Plantilla</span>
                </a>
                <button @click="showUploadModal = true"
                    class="inline-flex items-center justify-center px-3 py-2.5 bg-white border border-emerald-300 rounded-lg text-sm font-medium text-emerald-700 hover:bg-emerald-50 shadow-sm transition-colors"
                    title="Subir Excel con proveedores">
                    <svg class="w-4 h-4 mr-1.5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l4 4m0 0l4-4m-4 4V4"></path>
                    </svg>
                    <span class="hidden sm:inline">Subir Proveedores</span>
                    <span class="sm:hidden">Subir</span>
                </button>
            </div>
            <a href="{{ url_for('reports.export_orders_excel') }}"
                class="inline-flex items-center justify-center px-4 py-2.5 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 shadow-sm transition-colors">
                <svg class="w-4 h-4 mr-2 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                <span>Exportar Excel</span>
            </a>
            <button @click="openCreateModal()"
                class="inline-flex items-center justify-center px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium shadow-sm transition-colors text-sm">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <span>Nuevo Pedido</span>
            </button>
        </div>
    </div>

    <!-- Table Container -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <!-- Desktop Table View -->
        <div class="hidden md:block overflow-x-auto p-4">
            <table id="ordersTable" class="min-w-full divide-y divide-slate-200 display responsive nowrap"
                style="width:100%">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Proveedor</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">N° Factura</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Fecha</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Items</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Estado</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-200"></tbody>
            </table>
        </div>

        <!-- Mobile Card View -->
        <div class="md:hidden p-4 space-y-4" id="mobileOrdersList">
            <template x-for="order in orders" :key="order.id">
                <div class="bg-slate-50 rounded-lg border border-slate-200 p-4 space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs text-slate-500">#<span x-text="order.id"></span></span>
                            <h3 class="font-semibold text-slate-900 text-sm" x-text="order.supplier || 'Sin proveedor'"></h3>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium" :class="{
                                'bg-yellow-100 text-yellow-800': order.status === 'pending',
                                'bg-orange-100 text-orange-800': order.status === 'partially_received',
                                'bg-green-100 text-green-800': order.status === 'received',
                                'bg-blue-100 text-blue-800': order.status === 'paid'
                            }"
                            x-text="order.status === 'pending' ? 'Pendiente' : order.status === 'partially_received' ? 'Parcial' : order.status === 'received' ? 'Recibido' : 'Pagado'">
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div>
                            <span class="text-slate-500">Factura:</span>
                            <span class="text-slate-900 font-medium ml-1" x-text="order.invoice_number || '-'"></span>
                        </div>
                        <div>
                            <span class="text-slate-500">Fecha:</span>
                            <span class="text-slate-900 font-medium ml-1" x-text="order.created_at || '-'"></span>
                        </div>
                    </div>

                    <template x-if="order.line_items && order.line_items.length > 0">
                        <div class="text-xs text-slate-500">
                            <span x-text="order.line_items.length + ' producto(s) esperado(s)'"></span>
                        </div>
                    </template>

                    <div class="flex justify-between items-center pt-2 border-t border-slate-200">
                        <span class="text-lg font-bold text-primary-600"
                            x-text="'$' + (order.total || 0).toLocaleString('es-CL')"></span>
                        <div class="flex gap-2">
                            <button @click="editOrder(order.id)"
                                class="px-3 py-1.5 text-xs font-medium text-primary-600 bg-primary-50 hover:bg-primary-100 rounded-lg transition-colors">
                                Editar
                            </button>
                            <button @click="deleteOrder(order.id)"
                                class="px-3 py-1.5 text-xs font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
                                Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <div x-show="orders.length === 0" class="text-center py-8 text-slate-500">
                <svg class="w-12 h-12 mx-auto text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                </svg>
                <p class="text-sm">No hay pedidos registrados</p>
                <button @click="openCreateModal()" class="mt-3 text-primary-600 font-medium text-sm hover:underline">
                    Crear primer pedido
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Crear/Editar Pedido -->
    <div x-show="showModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100">
        <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm" @click="closeModal()"></div>

        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-xl shadow-xl w-full max-w-3xl p-6 max-h-[90vh] overflow-y-auto" @click.stop
                x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100">

                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-900"
                        x-text="editingId ? 'Editar Pedido #' + editingId : 'Nuevo Pedido'"></h2>
                    <button @click="closeModal()" class="text-slate-400 hover:text-slate-500 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Proveedor con búsqueda -->
                    <div class="relative" @click.away="supplierDropdownOpen = false">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Proveedor *</label>
                        <div class="flex gap-2">
                            <div class="flex-1 relative">
                                <input type="text" x-model="supplierSearch"
                                    @input="searchSuppliers()" @focus="supplierDropdownOpen = true"
                                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm"
                                    :placeholder="formData.supplier || 'Buscar proveedor...'"
                                    autocomplete="off">

                                <!-- Proveedor seleccionado -->
                                <template x-if="formData.supplier_id">
                                    <div class="absolute inset-y-0 right-2 flex items-center">
                                        <span class="text-xs bg-primary-100 text-primary-700 px-2 py-0.5 rounded-full flex items-center gap-1">
                                            <span x-text="formData.supplier"></span>
                                            <button @click="clearSupplier()" class="hover:text-primary-900">&times;</button>
                                        </span>
                                    </div>
                                </template>

                                <!-- Dropdown resultados -->
                                <div x-show="supplierDropdownOpen && (supplierResults.length > 0 || supplierSearch.length > 0)"
                                    class="absolute top-full left-0 right-0 mt-1 bg-white border border-slate-200 rounded-lg shadow-lg z-10 max-h-48 overflow-y-auto">
                                    <template x-for="s in supplierResults" :key="s.id">
                                        <button @click="selectSupplier(s)" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-50 flex justify-between items-center">
                                            <span x-text="s.name"></span>
                                            <span class="text-xs text-slate-400" x-text="s.rut || ''"></span>
                                        </button>
                                    </template>
                                    <div x-show="supplierResults.length === 0 && supplierSearch.length > 0"
                                        class="px-4 py-2 text-sm text-slate-500">
                                        Sin resultados
                                    </div>
                                    <button @click="showNewSupplierForm = true; supplierDropdownOpen = false"
                                        class="w-full px-4 py-2 text-left text-sm text-primary-600 hover:bg-primary-50 border-t border-slate-100 font-medium">
                                        + Crear nuevo proveedor
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Mini form nuevo proveedor -->
                        <div x-show="showNewSupplierForm" class="mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <h4 class="text-sm font-semibold text-slate-700 mb-2">Nuevo Proveedor</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div>
                                    <input type="text" x-model="newSupplier.name" placeholder="Nombre *"
                                        class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500">
                                </div>
                                <div>
                                    <input type="text" x-model="newSupplier.rut" placeholder="RUT (opcional)"
                                        class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500">
                                </div>
                                <div>
                                    <input type="text" x-model="newSupplier.abbreviation" placeholder="Abreviatura (ej: COSM)" maxlength="10"
                                        class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500">
                                </div>
                                <div>
                                    <input type="text" x-model="newSupplier.contact_info" placeholder="Contacto"
                                        class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500">
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 mt-3">
                                <button @click="showNewSupplierForm = false"
                                    class="px-3 py-1.5 text-xs text-slate-600 hover:bg-slate-200 rounded-lg">Cancelar</button>
                                <button @click="createSupplier()"
                                    class="px-3 py-1.5 text-xs bg-primary-600 text-white hover:bg-primary-700 rounded-lg font-medium">Guardar</button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">N° Factura *</label>
                            <input type="text" x-model="formData.invoice_number"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm"
                                placeholder="Ej: FAC-001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Total $</label>
                            <input type="number" x-model="formData.total"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm"
                                placeholder="0" :readonly="formData.items.length > 0"
                                :class="{'bg-slate-100 cursor-not-allowed': formData.items.length > 0}">
                            <p x-show="formData.items.length > 0" class="text-xs text-slate-500 mt-1">Auto-calculado desde items</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Notas</label>
                        <textarea x-model="formData.notes" rows="2"
                            class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm resize-none"
                            placeholder="Detalles del pedido..."></textarea>
                    </div>

                    <!-- Productos Esperados -->
                    <div class="border-t border-slate-200 pt-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-semibold text-slate-700">Productos Esperados <span class="text-slate-400 font-normal">(opcional)</span></h3>
                            <button @click="addLineItem()"
                                class="px-3 py-1.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-xs font-medium flex items-center gap-1">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Agregar
                            </button>
                        </div>

                        <div class="space-y-2">
                            <template x-for="(item, idx) in formData.items" :key="idx">
                                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                    <!-- Desktop -->
                                    <div class="hidden sm:grid sm:grid-cols-12 gap-2 items-end">
                                        <div class="col-span-5">
                                            <label class="block text-xs text-slate-500 mb-1">Producto</label>
                                            <select x-model="item.product_id" @change="onItemProductChange(idx)"
                                                class="w-full px-2 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500">
                                                <option value="">Seleccione...</option>
                                                <template x-for="p in allProducts" :key="p.id">
                                                    <option :value="p.id" x-text="p.name + (p.sku ? ' (' + p.sku + ')' : '')"></option>
                                                </template>
                                            </select>
                                        </div>
                                        <div class="col-span-2">
                                            <label class="block text-xs text-slate-500 mb-1">Cantidad</label>
                                            <input type="number" x-model.number="item.quantity_ordered" min="1" @input="recalcTotal()"
                                                class="w-full px-2 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500">
                                        </div>
                                        <div class="col-span-3">
                                            <label class="block text-xs text-slate-500 mb-1">Costo unit. $</label>
                                            <input type="number" x-model.number="item.unit_cost" min="0" step="1" @input="recalcTotal()"
                                                class="w-full px-2 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500">
                                        </div>
                                        <div class="col-span-1 text-right">
                                            <label class="block text-xs text-slate-500 mb-1">Sub</label>
                                            <span class="text-sm font-medium text-slate-700" x-text="'$' + ((item.quantity_ordered || 0) * (item.unit_cost || 0)).toLocaleString('es-CL')"></span>
                                        </div>
                                        <div class="col-span-1">
                                            <button @click="removeLineItem(idx)"
                                                class="w-full px-2 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg text-sm">
                                                <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Mobile -->
                                    <div class="sm:hidden space-y-2">
                                        <select x-model="item.product_id" @change="onItemProductChange(idx)"
                                            class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500">
                                            <option value="">Seleccione producto...</option>
                                            <template x-for="p in allProducts" :key="p.id">
                                                <option :value="p.id" x-text="p.name"></option>
                                            </template>
                                        </select>
                                        <div class="grid grid-cols-2 gap-2">
                                            <input type="number" x-model.number="item.quantity_ordered" min="1" @input="recalcTotal()" placeholder="Cantidad"
                                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                            <input type="number" x-model.number="item.unit_cost" min="0" step="1" @input="recalcTotal()" placeholder="Costo unit."
                                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-slate-600" x-text="'Subtotal: $' + ((item.quantity_ordered || 0) * (item.unit_cost || 0)).toLocaleString('es-CL')"></span>
                                            <button @click="removeLineItem(idx)" class="text-red-600 text-xs font-medium">Eliminar</button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <template x-if="formData.items.length > 0">
                            <div class="flex justify-end mt-2 text-sm font-bold text-slate-800">
                                Total: $<span x-text="computedTotal().toLocaleString('es-CL')"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Modal footer -->
                <div class="flex flex-col-reverse sm:flex-row justify-end gap-3 mt-6 pt-4 border-t border-slate-200">
                    <button @click="closeModal()"
                        class="w-full sm:w-auto px-4 py-2.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
                        Cancelar
                    </button>
                    <button @click="saveOrder()"
                        class="w-full sm:w-auto px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm font-medium shadow-sm transition-colors">
                        <span x-text="editingId ? 'Actualizar Pedido' : 'Crear Pedido'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Subir Proveedores -->
    <div x-show="showUploadModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;"
        x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm" @click="closeUploadModal()"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-900">Subir Proveedores desde Excel</h3>
                    <button @click="closeUploadModal()" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <p class="text-sm text-slate-600">
                        Sube un archivo Excel con los datos de proveedores.
                        <a href="{{ url_for('warehouse.download_supplier_template') }}" class="text-emerald-600 hover:text-emerald-700 font-medium underline">Descarga la plantilla</a>
                        si aún no la tienes.
                    </p>

                    <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:border-emerald-400 transition-colors">
                        <input type="file" accept=".xlsx,.xls" @change="handleFileSelect($event)"
                            class="hidden" id="supplierFile">
                        <label for="supplierFile" class="cursor-pointer">
                            <svg class="w-10 h-10 mx-auto text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <span class="text-sm font-medium text-slate-600" x-text="uploadFile ? uploadFile.name : 'Haz clic para seleccionar archivo .xlsx'"></span>
                        </label>
                    </div>

                    <!-- Resultados -->
                    <template x-if="uploadResults">
                        <div class="bg-slate-50 rounded-lg p-4 space-y-2 text-sm">
                            <div class="flex items-center gap-2 text-emerald-700 font-medium" x-show="uploadResults.created && uploadResults.created.length > 0">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span x-text="uploadResults.created.length + ' proveedores creados'"></span>
                            </div>
                            <template x-if="uploadResults.errors && uploadResults.errors.length > 0">
                                <div class="space-y-1">
                                    <div class="text-amber-700 font-medium">Advertencias:</div>
                                    <template x-for="err in uploadResults.errors" :key="err">
                                        <div class="text-slate-600 text-xs pl-2" x-text="err"></div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-200">
                    <button @click="closeUploadModal()"
                        class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50">
                        <span x-text="uploadResults ? 'Cerrar' : 'Cancelar'"></span>
                    </button>
                    <button @click="uploadSuppliers()" x-show="!uploadResults"
                        :disabled="!uploadFile || uploading"
                        class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 disabled:bg-slate-300 text-white rounded-lg text-sm font-medium shadow-sm transition-colors">
                        <span x-show="!uploading">Subir y Procesar</span>
                        <span x-show="uploading" class="flex items-center gap-2">
                            <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            Procesando...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function ordersPage() {
    return {
        showModal: false,
        showUploadModal: false,
        uploadFile: null,
        uploading: false,
        uploadResults: null,
        editingId: null,
        dataTable: null,
        orders: [],
        allProducts: [],
        supplierSearch: '',
        supplierResults: [],
        supplierDropdownOpen: false,
        showNewSupplierForm: false,
        newSupplier: { name: '', rut: '', abbreviation: '', contact_info: '' },
        formData: {
            supplier: '',
            supplier_id: '',
            invoice_number: '',
            notes: '',
            total: 0,
            items: []
        },

        init() {
            this.loadOrders();
            this.loadProducts();
        },

        async loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                this.allProducts = Array.isArray(data) ? data : (data.products || []);
            } catch (e) {
                console.error('Error loading products:', e);
            }
        },

        async searchSuppliers() {
            try {
                const response = await fetch(`/warehouse/api/suppliers?q=${encodeURIComponent(this.supplierSearch)}`);
                const data = await response.json();
                this.supplierResults = data.suppliers || [];
                this.supplierDropdownOpen = true;

                // Si escribieron algo pero no seleccionaron, usar como texto libre
                if (this.supplierSearch && !this.formData.supplier_id) {
                    this.formData.supplier = this.supplierSearch;
                }
            } catch (e) {
                console.error('Error searching suppliers:', e);
            }
        },

        selectSupplier(s) {
            this.formData.supplier = s.name;
            this.formData.supplier_id = s.id;
            this.supplierSearch = '';
            this.supplierDropdownOpen = false;
        },

        clearSupplier() {
            this.formData.supplier = '';
            this.formData.supplier_id = '';
            this.supplierSearch = '';
        },

        async createSupplier() {
            if (!this.newSupplier.name.trim()) {
                this.$dispatch('toast', { message: 'El nombre del proveedor es obligatorio', type: 'error' });
                return;
            }
            try {
                const response = await fetch('/warehouse/api/suppliers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newSupplier)
                });
                const data = await response.json();
                if (data.success) {
                    this.selectSupplier(data.supplier);
                    this.showNewSupplierForm = false;
                    this.newSupplier = { name: '', rut: '', abbreviation: '', contact_info: '' };
                    this.$dispatch('toast', { message: 'Proveedor creado', type: 'success' });
                } else {
                    this.$dispatch('toast', { message: data.error, type: 'error' });
                }
            } catch (e) {
                this.$dispatch('toast', { message: 'Error al crear proveedor', type: 'error' });
            }
        },

        addLineItem() {
            this.formData.items.push({ product_id: '', quantity_ordered: 1, unit_cost: 0 });
        },

        removeLineItem(idx) {
            this.formData.items.splice(idx, 1);
            this.recalcTotal();
        },

        onItemProductChange(idx) {
            // Nada extra por ahora
        },

        computedTotal() {
            return this.formData.items.reduce((sum, item) => {
                return sum + (item.quantity_ordered || 0) * (item.unit_cost || 0);
            }, 0);
        },

        recalcTotal() {
            if (this.formData.items.length > 0) {
                this.formData.total = this.computedTotal();
            }
        },

        async loadOrders() {
            try {
                const response = await fetch('/warehouse/api/orders');
                const data = await response.json();
                this.orders = data.orders || [];
            } catch (e) {
                console.error('Error loading orders:', e);
                this.orders = [];
            }

            if (this.dataTable) {
                this.dataTable.destroy();
            }

            this.dataTable = $('#ordersTable').DataTable({
                ajax: {
                    url: '/warehouse/api/orders',
                    dataSrc: 'orders'
                },
                columns: [
                    { data: 'id', render: (data) => `#${data}` },
                    { data: 'supplier', defaultContent: 'Sin proveedor' },
                    { data: 'invoice_number', defaultContent: '-' },
                    { data: 'created_at', defaultContent: '-' },
                    { data: 'total', render: (data) => `$${(data || 0).toLocaleString('es-CL')}` },
                    {
                        data: 'line_items',
                        render: (data) => {
                            if (!data || data.length === 0) return '<span class="text-slate-400 text-xs">-</span>';
                            return `<span class="text-xs text-slate-600">${data.length} producto(s)</span>`;
                        }
                    },
                    {
                        data: 'status',
                        render: (data) => {
                            const statusMap = {
                                'pending': '<span class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pendiente</span>',
                                'partially_received': '<span class="px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">Parcial</span>',
                                'received': '<span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Recibido</span>',
                                'paid': '<span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Pagado</span>'
                            };
                            return statusMap[data] || data;
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        className: 'text-right',
                        render: (data, type, row) => {
                            return `
                            <button onclick="ordersPageInstance.editOrder('${row.id}')" class="text-primary-600 hover:text-primary-800 font-medium text-sm mr-3">Editar</button>
                            <button onclick="ordersPageInstance.deleteOrder('${row.id}')" class="text-red-600 hover:text-red-800 font-medium text-sm">Eliminar</button>
                            `;
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json',
                    search: "_INPUT_",
                    searchPlaceholder: "Buscar pedidos...",
                    lengthMenu: "Mostrar _MENU_ pedidos"
                },
                order: [[0, 'desc']],
                responsive: true,
                pageLength: 25,
                dom: '<"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4"lf>rt<"flex flex-col sm:flex-row justify-between items-center gap-4 mt-4"ip>'
            });
        },

        openCreateModal() {
            this.editingId = null;
            this.formData = {
                supplier: '',
                supplier_id: '',
                invoice_number: '',
                notes: '',
                total: 0,
                items: []
            };
            this.supplierSearch = '';
            this.supplierResults = [];
            this.showNewSupplierForm = false;
            this.showModal = true;
        },

        async editOrder(id) {
            try {
                const response = await fetch('/warehouse/api/orders');
                const data = await response.json();
                const order = data.orders.find(o => o.id === id);

                if (order) {
                    this.editingId = id;
                    this.formData = {
                        supplier: order.supplier || '',
                        supplier_id: order.supplier_id || '',
                        invoice_number: order.invoice_number || '',
                        notes: order.notes || '',
                        total: order.total || 0,
                        items: (order.line_items || []).map(li => ({
                            product_id: li.product_id || '',
                            quantity_ordered: li.quantity_ordered || 1,
                            unit_cost: li.unit_cost || 0
                        }))
                    };
                    this.supplierSearch = '';
                    this.showNewSupplierForm = false;
                    this.showModal = true;
                }
            } catch (error) {
                console.error('Error:', error);
                this.$dispatch('toast', { message: 'Error al cargar datos del pedido', type: 'error' });
            }
        },

        async saveOrder() {
            if (!this.formData.supplier && !this.formData.supplier_id) {
                this.$dispatch('toast', { message: 'Debes ingresar el nombre del proveedor', type: 'error' });
                return;
            }

            if (!this.formData.invoice_number) {
                this.$dispatch('toast', { message: 'El número de factura es obligatorio', type: 'error' });
                return;
            }

            // Validar items si hay
            for (let i = 0; i < this.formData.items.length; i++) {
                const item = this.formData.items[i];
                if (!item.product_id) {
                    this.$dispatch('toast', { message: `Item ${i + 1}: seleccione un producto`, type: 'error' });
                    return;
                }
                if (!item.quantity_ordered || item.quantity_ordered <= 0) {
                    this.$dispatch('toast', { message: `Item ${i + 1}: cantidad debe ser mayor a 0`, type: 'error' });
                    return;
                }
            }

            try {
                const url = this.editingId
                    ? `/warehouse/api/orders/${this.editingId}`
                    : '/warehouse/api/orders';
                const method = this.editingId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.formData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    this.$dispatch('toast', { message: data.message, type: 'success' });
                    this.closeModal();
                    this.dataTable.ajax.reload();
                    this.refreshMobileList();
                } else {
                    this.$dispatch('toast', { message: data.error || 'Error desconocido', type: 'error' });
                }
            } catch (error) {
                console.error('Error:', error);
                this.$dispatch('toast', { message: 'Error de conexión', type: 'error' });
            }
        },

        async deleteOrder(id) {
            if (!confirm('¿Estás seguro de eliminar este pedido?')) return;

            try {
                const response = await fetch(`/warehouse/api/orders/${id}`, { method: 'DELETE' });
                const data = await response.json();

                if (response.ok && data.success) {
                    this.$dispatch('toast', { message: data.message, type: 'success' });
                    this.dataTable.ajax.reload();
                    this.refreshMobileList();
                } else {
                    this.$dispatch('toast', { message: data.error || 'Error desconocido', type: 'error' });
                }
            } catch (error) {
                console.error('Error:', error);
                this.$dispatch('toast', { message: 'Error de conexión', type: 'error' });
            }
        },

        closeModal() {
            this.showModal = false;
            this.editingId = null;
        },

        async refreshMobileList() {
            try {
                const response = await fetch('/warehouse/api/orders');
                const data = await response.json();
                this.orders = data.orders || [];
            } catch (e) {
                console.error('Error refreshing mobile list:', e);
            }
        },

        handleFileSelect(event) {
            this.uploadFile = event.target.files[0] || null;
            this.uploadResults = null;
        },

        async uploadSuppliers() {
            if (!this.uploadFile) {
                this.$dispatch('toast', { message: 'Selecciona un archivo Excel', type: 'error' });
                return;
            }
            this.uploading = true;
            this.uploadResults = null;
            try {
                const formData = new FormData();
                formData.append('file', this.uploadFile);
                const response = await fetch('/warehouse/api/suppliers/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    this.uploadResults = data;
                    this.$dispatch('toast', { message: data.message, type: 'success' });
                } else {
                    this.$dispatch('toast', { message: data.error || 'Error al procesar archivo', type: 'error' });
                }
            } catch (error) {
                console.error('Error:', error);
                this.$dispatch('toast', { message: 'Error de conexión', type: 'error' });
            } finally {
                this.uploading = false;
            }
        },

        closeUploadModal() {
            this.showUploadModal = false;
            this.uploadFile = null;
            this.uploadResults = null;
            this.uploading = false;
        }
    };
}

let ordersPageInstance = null;

document.addEventListener('alpine:init', () => {
    Alpine.data('ordersPage', ordersPage);
});

document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const el = document.querySelector('[x-data="ordersPage()"]');
        if (el && el._x_dataStack) {
            ordersPageInstance = el._x_dataStack[0];
        }
    }, 100);
});
</script>
{% endblock %}
