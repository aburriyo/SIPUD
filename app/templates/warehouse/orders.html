{% extends "base.html" %}

{% block title %}Pedidos a Proveedores{% endblock %}

{% block content %}
<div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4" x-data="ordersPage()">
    <div>
        <h1 class="text-3xl font-bold text-slate-900">Pedidos a Proveedores</h1>
        <p class="text-slate-600 mt-1">Registra y gestiona órdenes de compra</p>
    </div>
    <button @click="openCreateModal()"
        class="px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium shadow-sm transition-colors flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Nuevo Pedido
    </button>

    <!-- Tabla de Pedidos -->
    <div class="w-full bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden p-6 mt-4">
        <table id="ordersTable" class="min-w-full divide-y divide-slate-200">
            <thead class="bg-slate-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Proveedor</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">N° Factura</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Fecha</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Estado</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-200">
                <!-- Datos cargados via DataTables -->
            </tbody>
        </table>
    </div>

    <!-- Modal Crear/Editar Pedido -->
    <div x-show="showModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" @click.self="closeModal()">
        <div class="fixed inset-0 bg-slate-900/50"></div>
        
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-xl shadow-xl max-w-2xl w-full p-6" @click.stop>
                <h2 class="text-2xl font-bold text-slate-900 mb-4" x-text="editingId ? 'Editar Pedido' : 'Nuevo Pedido a Proveedor'"></h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Proveedor *</label>
                        <input type="text" x-model="formData.supplier" 
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            placeholder="Nombre del proveedor">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">N° Factura</label>
                        <input type="text" x-model="formData.invoice_number" 
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            placeholder="Número de factura">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Total $</label>
                        <input type="number" x-model="formData.total" 
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            placeholder="0">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Notas</label>
                        <textarea x-model="formData.notes" rows="3"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            placeholder="Detalles del pedido..."></textarea>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button @click="closeModal()"
                            class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition-colors">
                            Cancelar
                        </button>
                        <button @click="saveOrder()"
                            class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors">
                            <span x-text="editingId ? 'Actualizar' : 'Crear Pedido'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function ordersPage() {
    return {
        showModal: false,
        editingId: null,
        dataTable: null,
        formData: {
            supplier: '',
            invoice_number: '',
            notes: '',
            total: 0
        },
        
        init() {
            this.loadOrders();
        },
        
        loadOrders() {
            if (this.dataTable) {
                this.dataTable.destroy();
            }
            
            this.dataTable = $('#ordersTable').DataTable({
                ajax: {
                    url: '/warehouse/api/orders',
                    dataSrc: 'orders'
                },
                columns: [
                    { data: 'id', render: (data) => `#${data}` },
                    { data: 'supplier', defaultContent: 'Sin proveedor' },
                    { data: 'invoice_number', defaultContent: '-' },
                    { data: 'created_at', defaultContent: '-' },
                    { data: 'total', render: (data) => `$${(data || 0).toLocaleString('es-CL')}` },
                    { 
                        data: 'status',
                        render: (data) => {
                            const statusMap = {
                                'pending': '<span class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pendiente</span>',
                                'received': '<span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Recibido</span>',
                                'paid': '<span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Pagado</span>'
                            };
                            return statusMap[data] || data;
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        className: 'text-right',
                        render: (data, type, row) => {
                            return `
                                <button onclick="ordersPageInstance.editOrder(${row.id})" class="text-primary-600 hover:text-primary-800 font-medium text-sm mr-3">
                                    Editar
                                </button>
                                <button onclick="ordersPageInstance.deleteOrder(${row.id})" class="text-red-600 hover:text-red-800 font-medium text-sm">
                                    Eliminar
                                </button>
                            `;
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json'
                },
                order: [[0, 'desc']],
                responsive: true
            });
        },
        
        openCreateModal() {
            this.editingId = null;
            this.formData = {
                supplier: '',
                invoice_number: '',
                notes: '',
                total: 0
            };
            this.showModal = true;
        },
        
        async editOrder(id) {
            try {
                const response = await fetch('/warehouse/api/orders');
                const data = await response.json();
                const order = data.orders.find(o => o.id === id);
                
                if (order) {
                    this.editingId = id;
                    this.formData = {
                        supplier: order.supplier || '',
                        invoice_number: order.invoice_number || '',
                        notes: order.notes || '',
                        total: order.total || 0
                    };
                    this.showModal = true;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar datos del pedido');
            }
        },
        
        async saveOrder() {
            if (!this.formData.supplier) {
                alert('Debes ingresar el nombre del proveedor');
                return;
            }
            
            try {
                const url = this.editingId 
                    ? `/warehouse/api/orders/${this.editingId}`
                    : '/warehouse/api/orders';
                const method = this.editingId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.formData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(data.message);
                    this.closeModal();
                    this.dataTable.ajax.reload();
                } else {
                    alert('Error: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión');
            }
        },
        
        async deleteOrder(id) {
            if (!confirm('¿Estás seguro de eliminar este pedido?')) {
                return;
            }
            
            try {
                const response = await fetch(`/warehouse/api/orders/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert(data.message);
                    this.dataTable.ajax.reload();
                } else {
                    alert('Error: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión');
            }
        },
        
        closeModal() {
            this.showModal = false;
            this.editingId = null;
        }
    };
}

// Global instance para ser accedida desde botones
let ordersPageInstance;
document.addEventListener('alpine:init', () => {
    Alpine.data('ordersPage', ordersPage);
});
document.addEventListener('DOMContentLoaded', () => {
    ordersPageInstance = ordersPage();
    ordersPageInstance.init();
});
</script>
{% endblock %}
