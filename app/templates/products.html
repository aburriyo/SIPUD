{% extends "base.html" %}

{% block title %}Productos{% endblock %}

{% block content %}
<div x-data="productsTable()">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4 sm:mb-6">
        <div>
            <h1 class="text-xl sm:text-2xl font-bold text-slate-800">Cat치logo de Productos</h1>
            <p class="text-xs sm:text-sm text-slate-500">Gestiona el inventario de {{ current_tenant.name }}</p>
        </div>
        <button @click="openAddModal()"
            class="inline-flex items-center justify-center px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm w-full sm:w-auto">
            <svg class="w-5 h-5 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span class="hidden sm:inline">Nuevo Producto</span>
            <span class="sm:hidden ml-2">Nuevo</span>
        </button>
    </div>

    <!-- Search and Filters - Removed, DataTables handles this -->
    
    <!-- Table Card -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden p-4">
        <table id="productsTable" class="min-w-full divide-y divide-slate-200 display responsive nowrap" style="width:100%">
            <thead class="bg-slate-50">
                <tr>
                    <th class="px-3 sm:px-6 py-3">Nombre</th>
                    <th class="px-3 sm:px-6 py-3">SKU</th>
                    <th class="px-3 sm:px-6 py-3">Categor칤a</th>
                    <th class="px-3 sm:px-6 py-3">Precio</th>
                    <th class="px-3 sm:px-6 py-3">Stock</th>
                    <th class="px-3 sm:px-6 py-3 text-right">Acciones</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-200">
                {% for product in products %}
                <tr>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm font-semibold text-slate-900">
                        {{ product.name }}
                    </td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm text-slate-600">
                        {{ product.sku }}
                    </td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4">
                        {% set category = product.category or 'Otros' %}
                        {% if category == 'Cajas y Promociones' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                            游닍 {{ category }}
                        </span>
                        {% elif category == 'Conservas' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">
                            游볾 {{ category }}
                        </span>
                        {% elif category == 'Granos y Cereales' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-amber-100 text-amber-800">
                            游 {{ category }}
                        </span>
                        {% elif category == 'Aceites' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                            游 {{ category }}
                        </span>
                        {% elif category == 'Pastas y Fideos' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-lime-100 text-lime-800">
                            游꼫 {{ category }}
                        </span>
                        {% elif category == 'L치cteos' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            游볱 {{ category }}
                        </span>
                        {% elif category == 'Verduras y Vegetales' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            游볭 {{ category }}
                        </span>
                        {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-slate-100 text-slate-800">
                            游늷 {{ category }}
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm text-slate-700">
                        ${{ "{:,.0f}".format(product.base_price) }}
                    </td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4">
                        <span class="inline-flex items-center px-2 sm:px-2.5 py-0.5 rounded-full text-xs font-medium
                            {{ 'bg-red-100 text-red-800' if product.total_stock <= product.critical_stock else 'bg-green-100 text-green-800' }}">
                            {{ product.total_stock }} Unidades
                        </span>
                    </td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 text-right text-xs sm:text-sm font-medium">
                        <button onclick="Alpine.store('productsTable') || window.dispatchEvent(new CustomEvent('open-edit-modal', {detail: {id: {{ product.id }} }}))"
                            @click.stop="openEditModal({{ product.id }})"
                            class="inline-flex items-center px-3 py-1.5 bg-primary-50 text-primary-700 hover:bg-primary-100 rounded-lg text-xs font-medium transition-colors">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Editar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal (Tailwind) -->
    <div x-show="showModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

        <!-- Backdrop -->
        <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" @click="showModal = false"></div>

        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <!-- Modal Panel -->
            <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">

                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div
                            class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-primary-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-primary-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3.25h3m-3-3.75h3m-12-3h15.75c.828 0 1.5.672 1.5 1.5v2.251c0 .414-.336.75-.75.75h-1.5a.75.75 0 01-.75-.75V6.75a.75.75 0 00-.75-.75H4.5a.75.75 0 00-.75.75v3.375c0 .414-.336.75-.75.75h-1.5A.75.75 0 01.75 9.75V4.5C.75 3.672 1.422 3 2.25 3h15.75M2.25 9V5.25m19.5 0V9" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-base font-semibold leading-6 text-slate-900" id="modal-title"
                                x-text="isEdit ? 'Editar Producto' : 'Nuevo Producto'"></h3>
                            <div class="mt-4 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Nombre del Producto</label>
                                    <input type="text" x-model="formData.name"
                                        class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Descripci칩n</label>
                                    <textarea x-model="formData.description" rows="2"
                                        class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border"
                                        placeholder="Descripci칩n detallada del producto..."></textarea>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700">SKU</label>
                                        <input type="text" x-model="formData.sku"
                                            class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700">Categor칤a</label>
                                        <select x-model="formData.category"
                                            class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                                            <option value="Cajas y Promociones">游닍 Cajas y Promociones</option>
                                            <option value="Granos y Cereales">游 Granos y Cereales</option>
                                            <option value="Aceites">游 Aceites</option>
                                            <option value="Pastas y Fideos">游꼫 Pastas y Fideos</option>
                                            <option value="Conservas">游볾 Conservas</option>
                                            <option value="L치cteos">游볱 L치cteos</option>
                                            <option value="Verduras y Vegetales">游볭 Verduras y Vegetales</option>
                                            <option value="Otros">游늷 Otros</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700">Precio Base</label>
                                        <input type="number" x-model="formData.base_price"
                                            class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700">Stock Cr칤tico</label>
                                        <input type="number" x-model="formData.critical_stock"
                                            class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm px-3 py-2 border">
                                    </div>
                                </div>
                            </div>

                            <!-- Bundle Contents (only for Cajas y Promociones) -->
                            <div x-show="formData.category === 'Cajas y Promociones'" class="border-t pt-4 mt-4">
                                <div class="flex justify-between items-center mb-3">
                                    <label class="block text-sm font-medium text-slate-700">游닍 Contenido del
                                        Bundle</label>
                                    <button type="button" @click="showBundleSelector = !showBundleSelector"
                                        class="text-xs text-primary-600 hover:text-primary-700 font-medium">
                                        + Agregar Producto
                                    </button>
                                </div>

                                <!-- Add product selector -->
                                <div x-show="showBundleSelector" class="mb-3 p-3 bg-slate-50 rounded-lg">
                                    <div class="grid grid-cols-3 gap-2">
                                        <select x-model="newBundleComponent.product_id"
                                            class="col-span-2 text-sm rounded-md border-slate-300 px-2 py-1">
                                            <option value="">Seleccionar producto...</option>
                                            <template x-for="product in availableProducts" :key="product.id">
                                                <option :value="product.id" x-text="product.name"></option>
                                            </template>
                                        </select>
                                        <input type="number" x-model="newBundleComponent.quantity" min="1"
                                            placeholder="Cant." class="text-sm rounded-md border-slate-300 px-2 py-1">
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                        <button type="button" @click="addBundleComponent"
                                            class="flex-1 text-xs px-2 py-1 bg-primary-600 text-white rounded hover:bg-primary-700">
                                            Agregar
                                        </button>
                                        <button type="button" @click="showBundleSelector = false"
                                            class="flex-1 text-xs px-2 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300">
                                            Cancelar
                                        </button>
                                    </div>
                                </div>

                                <!-- Bundle components list -->
                                <div class="space-y-2">
                                    <template x-for="(component, index) in formData.bundle_components" :key="index">
                                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded text-sm">
                                            <span class="flex-1" x-text="component.product_name"></span>
                                            <span class="text-slate-600 mx-2" x-text="'x' + component.quantity"></span>
                                            <button type="button" @click="removeBundleComponent(index)"
                                                class="text-red-600 hover:text-red-800">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                    <p x-show="!formData.bundle_components || formData.bundle_components.length === 0"
                                        class="text-xs text-slate-500 italic">
                                        No hay productos en este bundle. Haz clic en "Agregar Producto" para comenzar.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                <button type="button" @click="saveProduct"
                    class="inline-flex w-full justify-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 sm:ml-3 sm:w-auto">
                    Guardar
                </button>
                <button type="button" @click="showModal = false"
                    class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 sm:mt-0 sm:w-auto">
                    Cancelar
                </button>
                <!-- Delete button (only show in edit mode) -->
                <button type="button" x-show="isEdit" @click="confirmDelete"
                    class="mt-3 inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:mt-0 sm:mr-auto sm:w-auto">
                    Eliminar
                </button>
            </div>
        </div>
    </div>
</div>
</div>

<script>
    function productsTable() {
        return {
            showModal: false,
            isEdit: false,
            searchQuery: '',
            selectedCategory: '',
            selectedTag: '',
            showBundleSelector: false,
            availableProducts: [],
            newBundleComponent: {
                product_id: '',
                quantity: 1
            },
            formData: {
                id: null,
                sku: '',
                name: '',
                description: '',
                category: 'Otros',
                base_price: 0,
                critical_stock: 10,
                bundle_components: []
            },
            async init() {
                // Fetch all products for bundle selection
                try {
                    const response = await fetch('/api/products');
                    if (response.ok) {
                        this.availableProducts = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading products:', error);
                }
            },
            addBundleComponent() {
                if (!this.newBundleComponent.product_id || !this.newBundleComponent.quantity) {
                    alert('Por favor selecciona un producto y cantidad');
                    return;
                }

                // Find product name
                const product = this.availableProducts.find(p => p.id == this.newBundleComponent.product_id);
                if (!product) return;

                // Check if already added
                const existing = this.formData.bundle_components.find(c => c.component_id == this.newBundleComponent.product_id);
                if (existing) {
                    alert('Este producto ya est치 en el bundle');
                    return;
                }

                this.formData.bundle_components.push({
                    component_id: parseInt(this.newBundleComponent.product_id),
                    product_name: product.name,
                    quantity: parseInt(this.newBundleComponent.quantity)
                });

                // Reset form
                this.newBundleComponent = { product_id: '', quantity: 1 };
                this.showBundleSelector = false;
            },
            removeBundleComponent(index) {
                this.formData.bundle_components.splice(index, 1);
            },
            openAddModal() {
                this.isEdit = false;
                this.formData = {
                    id: null,
                    sku: '',
                    name: '',
                    description: '',
                    category: 'Otros',
                    base_price: 0,
                    critical_stock: 10
                };
                this.showModal = true;
            },
            openEditModal(id) {
                this.isEdit = true;
                this.fetchProduct(id);
            },
            async fetchProduct(id) {
                try {
                    const response = await fetch(`/api/products/${id}`);
                    if (!response.ok) throw new Error('Failed to fetch');
                    const data = await response.json();
                    this.formData = data;
                    this.showModal = true;
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error cargando producto.');
                }
            },
            async saveProduct() {
                const url = this.isEdit ? `/api/products/${this.formData.id}` : '/api/products';
                const method = this.isEdit ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(this.formData),
                    });

                    if (response.ok) {
                        this.showModal = false;
                        window.location.reload();
                    } else {
                        const errorData = await response.json();
                        alert('Error: ' + errorData.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error guardando producto.');
                }
            },
            confirmDelete() {
                // First confirmation
                if (confirm(`쮼st치s seguro de que deseas eliminar "${this.formData.name}"?`)) {
                    // Second confirmation
                    if (confirm(`丘멆잺 ADVERTENCIA: Esta acci칩n eliminar치 el producto "${this.formData.name}" y todo su stock asociado.\n\n쮺onfirmas la eliminaci칩n permanente?`)) {
                        this.deleteProduct();
                    }
                }
            },
            async deleteProduct() {
                try {
                    const response = await fetch(`/api/products/${this.formData.id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        this.showModal = false;
                        window.location.reload();
                    } else {
                        const errorData = await response.json();
                        alert('Error eliminando producto: ' + errorData.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error eliminando producto.');
                }
            }
        }
    }
    
    // Initialize DataTable after DOM is ready
    $(document).ready(function() {
        var table = $('#productsTable').DataTable({
            responsive: {
                details: {
                    type: 'column',
                    target: 'tr'
                }
            },
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json',
                search: "_INPUT_",
                searchPlaceholder: "Buscar productos...",
                lengthMenu: "Mostrar _MENU_ productos"
            },
            pageLength: 25,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
            order: [[0, 'asc']], // Order by name (now first column)
            columnDefs: [
                { orderable: false, targets: -1 }, // Disable ordering on Actions column
                { className: 'text-center', targets: [2, 4] }, // Center category and stock
                { responsivePriority: 1, targets: 0 }, // Keep Name visible (highest priority)
                { responsivePriority: 2, targets: -1 }, // Keep Actions visible
                { responsivePriority: 3, targets: 1 } // Keep SKU visible (lower priority)
            ],
            dom: '<"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4"lf>rt<"flex flex-col sm:flex-row justify-between items-center gap-4 mt-4"ip>'
        });
        
        // Custom search styling
        $('.dataTables_filter input').addClass('w-full sm:w-64');
    });
</script>
{% endblock %}